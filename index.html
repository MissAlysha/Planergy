<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planergy</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #5B8FF9;
            --primary-hover: #4A7FE8;
            --text: #37352F;
            --text-secondary: #787774;
            --bg: #F7F6F3;
            --surface: #FFFFFF;
            --border: #E3E2DF;
            --shadow: 0 1px 3px rgba(15, 15, 15, 0.1);
            --shadow-lg: 0 8px 24px rgba(15, 15, 15, 0.12);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            padding: 40px 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 48px;
        }

        h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text);
            margin-bottom: 8px;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 400;
        }

        /* TWO COLUMN LAYOUT - EQUAL WIDTHS */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .left-column, .right-column {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        /* Card Styling */
        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 28px;
            box-shadow: var(--shadow);
        }

        .card h2 {
            font-size: 1.4rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 18px;
        }

        /* Brain Dump Section */
        .brain-dump-section {
            text-align: center;
        }

        .brain-dump-subtitle {
            color: var(--text-secondary);
            font-size: 0.88rem;
            margin-bottom: 24px;
        }

        .voice-button-large {
            width: 90px;
            height: 90px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 18px;
            box-shadow: var(--shadow-lg);
            transition: all 0.3s ease;
        }

        .voice-button-large:hover {
            background: var(--primary-hover);
            transform: scale(1.05);
        }

        .voice-button-large.recording {
            background: #EF4444;
            animation: pulse 1.5s infinite;
        }

        .voice-button-large svg {
            width: 36px;
            height: 36px;
            fill: white;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        .or-divider {
            color: var(--text-secondary);
            font-size: 0.82rem;
            margin: 14px 0;
        }

        .type-tasks-btn {
            padding: 9px 26px;
            background: var(--surface);
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.92rem;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .type-tasks-btn:hover {
            border-color: var(--primary);
            background: #FAFAF9;
        }

        .text-input-area {
            display: none;
            margin-top: 18px;
            text-align: left;
        }

        .text-input-area.active {
            display: block;
        }

        textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.92rem;
            font-family: inherit;
            resize: vertical;
            min-height: 120px;
            margin-bottom: 10px;
            color: var(--text);
            background: var(--surface);
        }

        textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        textarea::placeholder {
            color: var(--text-secondary);
        }

        .btn-add-task {
            padding: 9px 18px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.92rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-add-task:hover {
            background: var(--primary-hover);
        }

        /* Energy & Communication Sections */
        .energy-label {
            font-size: 1.4rem;
            color: var(--text);
            font-weight: 600;
            margin-bottom: 18px;
        }

        .energy-buttons {
            display: flex;
            gap: 8px;
        }

        .energy-btn {
            flex: 1;
            padding: 9px 14px;
            border: 2px solid var(--border);
            border-radius: 8px;
            background: var(--surface);
            font-size: 0.88rem;
            font-weight: 500;
            color: var(--text);
            cursor: pointer;
            transition: all 0.2s;
        }

        .energy-btn:hover {
            border-color: var(--primary);
        }

        .energy-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        /* Task List Section */
        .task-list {
            display: flex;
            flex-direction: column;
            gap: 9px;
        }

        .task-item {
            display: flex;
            align-items: center;
            gap: 9px;
            padding: 11px 13px;
            background: var(--bg);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .task-item.important {
            background: #FEF3C7;
            border-color: #FCD34D;
        }

        .task-text {
            flex: 1;
            font-size: 0.92rem;
            color: var(--text);
        }

        .priority-toggle {
            display: flex;
            border-radius: 8px;
            border: 2px solid var(--border);
            overflow: hidden;
            background: var(--surface);
            cursor: pointer;
            transition: all 0.2s;
            min-width: 160px;
        }

        .priority-toggle:hover {
            border-color: var(--primary);
        }

        .priority-toggle-option {
            flex: 1;
            padding: 6px 12px;
            font-size: 0.78rem;
            font-weight: 500;
            text-align: center;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .priority-toggle-option {
            background: var(--surface);
            color: var(--text-secondary);
        }

        .priority-toggle.flexible-selected .priority-toggle-option.flexible {
            background: var(--primary);
            color: white;
        }

        .priority-toggle.flexible-selected .priority-toggle-option.important {
            background: var(--surface);
            color: var(--text-secondary);
        }

        .priority-toggle.important-selected .priority-toggle-option.important {
            background: var(--primary);
            color: white;
        }

        .priority-toggle.important-selected .priority-toggle-option.flexible {
            background: var(--surface);
            color: var(--text-secondary);
        }

        .btn-delete {
            padding: 5px 10px;
            background: transparent;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.78rem;
            transition: all 0.2s;
        }

        .btn-delete:hover {
            background: #FEE2E2;
            color: #DC2626;
        }

        /* Schedule Section with Checkboxes */
        .schedule-timeline {
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
            padding-left: 65px;
        }

        .timeline-row {
            display: flex;
            align-items: stretch;
            min-height: 48px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .timeline-row:last-child {
            border-bottom: none;
        }

        .timeline-hour {
            position: absolute;
            left: -65px;
            width: 58px;
            text-align: right;
            font-size: 0.78rem;
            color: var(--text-secondary);
            font-weight: 500;
            padding-top: 4px;
        }

        .timeline-content {
            flex: 1;
            padding: 5px 9px;
        }

        .timeline-event {
            background: #E0E7FF;
            border-left: 3px solid var(--primary);
            border-radius: 6px;
            padding: 9px;
            margin: 3px 0;
            display: flex;
            align-items: center;
            gap: 9px;
            transition: all 0.2s;
            cursor: move;
        }

        .timeline-event:hover {
            box-shadow: var(--shadow);
            transform: translateX(2px);
        }

        .timeline-event.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .timeline-row.drag-over {
            background-color: #F0F9FF;
        }

        .timeline-event:focus {
            outline: 3px solid #A5B4FC;
            outline-offset: 2px;
        }

        .timeline-event.important {
            background: #FEF3C7;
            border-left-color: #F59E0B;
        }

        .timeline-event.dopamine {
            background: #FCE7F3;
            border-left-color: #EC4899;
        }

        .timeline-event.completed {
            opacity: 0.6;
        }

        .timeline-event.completed .timeline-event-title {
            text-decoration: line-through;
        }

        .timeline-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .timeline-event-content {
            flex: 1;
        }

        .timeline-event-title {
            font-size: 0.88rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 2px;
        }

        .timeline-event-time {
            font-size: 0.74rem;
            color: var(--text-secondary);
        }

        /* Dopamine Menu */
        .dopamine-card {
            background: #FCE7F3;
            border: 2px solid #F9A8D4;
        }

        .dopamine-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .dopamine-header h2 {
            margin: 0;
            display: inline-block;
        }

        .dopamine-toggle-icon {
            margin-left: 10px;
            font-size: 1.1rem;
        }

        .dopamine-add-btn {
            background: #EC4899;
            padding: 7px 13px;
            font-size: 0.82rem;
        }

        .dopamine-add-btn:hover {
            background: #DB2777;
        }

        .dopamine-content {
            display: none;
            margin-top: 14px;
        }

        .dopamine-content.active {
            display: block;
        }

        .dopamine-subtitle {
            color: var(--text-secondary);
            font-size: 0.82rem;
            margin-bottom: 12px;
        }

        .dopamine-item {
            background: white;
            border: 2px solid #F9A8D4;
            cursor: pointer;
        }

        .dopamine-item:hover {
            background: #FFF7FB;
        }

        .empty-state {
            text-align: center;
            padding: 28px;
            color: var(--text-secondary);
            font-size: 0.88rem;
        }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        button:focus,
        input:focus,
        textarea:focus,
        [tabindex]:focus {
            outline: 3px solid #A5B4FC;
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Planergy</h1>
            <p class="subtitle">Plan your day based on your energy level</p>
        </header>

        <div class="main-grid">
            <!-- LEFT COLUMN -->
            <div class="left-column">
                <!-- 1. Record Your Thoughts -->
                <div class="card brain-dump-section" role="region" aria-labelledby="brain-dump-heading">
                    <h2 id="brain-dump-heading">Step 1: Add Your Tasks</h2>
                    <p class="brain-dump-subtitle">Type one task per line or record one task with voice</p>
                    
                    <button class="voice-button-large" 
                        id="voiceBtn" 
                        onclick="toggleVoice()"
                        aria-label="Start voice recording. Click to record your tasks using your microphone."
                        aria-pressed="false">
                        <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"/>
                            <path d="M17 11c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92h-2z"/>
                        </svg>
                    </button>

                    <div class="or-divider" aria-hidden="true">or</div>
                    
                    <button class="type-tasks-btn" 
                        onclick="toggleTextInput()"
                        aria-label="Open text input to type your tasks"
                        aria-expanded="false"
                        aria-controls="textInputArea">Type Tasks</button>

                    <div class="text-input-area" 
                        id="textInputArea" 
                        role="region"
                        aria-label="Task input area"
                        aria-hidden="true">
                        <textarea id="taskInput" 
                            placeholder="Type your tasks"
                            aria-label="Enter your tasks. Each line will become a separate task. Press Shift+Enter for a new line."
                            aria-describedby="task-input-help"></textarea>
                        <span id="task-input-help" class="sr-only">Enter tasks, one per line. Press Add All Tasks when done.</span>
                        <button class="btn-add-task" 
                            onclick="addTask()"
                            aria-label="Add all tasks from the text input to your task list">Add All Tasks</button>
                    </div>
                </div>

                <!-- 2. Energy Level -->
                <div class="card" role="region" aria-labelledby="energy-heading">
                    <div class="energy-label" id="energy-heading">Step 2: Choose Today's Energy Level</div>
                    <div class="energy-buttons" role="radiogroup" aria-labelledby="energy-heading">
                        <button class="energy-btn" 
                            onclick="setEnergy('low')"
                            role="radio"
                            aria-checked="false"
                            aria-label="Set energy level to low">Low</button>
                        <button class="energy-btn active" 
                            onclick="setEnergy('medium')"
                            role="radio"
                            aria-checked="true"
                            aria-label="Set energy level to medium">Medium</button>
                        <button class="energy-btn" 
                            onclick="setEnergy('high')"
                            role="radio"
                            aria-checked="false"
                            aria-label="Set energy level to high">High</button>
                    </div>
                </div>

                <!-- 3. Communication Preference -->
                <div class="card" role="region" aria-labelledby="communication-heading">
                    <div class="energy-label" id="communication-heading">Step 3: Choose How You Want to Communicate</div>
                    <div class="energy-buttons" role="radiogroup" aria-labelledby="communication-heading">
                        <button class="energy-btn active" 
                            id="verbalBtn" 
                            onclick="setCommunicationMode('verbal')"
                            role="radio"
                            aria-checked="true"
                            aria-label="Set communication mode to verbal - voice input enabled">Can Talk</button>
                        <button class="energy-btn" 
                            id="nonverbalBtn" 
                            onclick="setCommunicationMode('nonverbal')"
                            role="radio"
                            aria-checked="false"
                            aria-label="Set communication mode to non-verbal - text input only">Non-Verbal</button>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN -->
            <div class="right-column">
                <!-- 1. Your Tasks -->
                <div class="card" role="region" aria-labelledby="tasks-heading">
                    <h2 id="tasks-heading">Step 4: Review and Prioritise Your Tasks</h2>
                    <div class="task-list" 
                        id="taskList" 
                        role="list"
                        aria-label="List of your tasks">
                        <div class="empty-state" role="status" aria-live="polite">No tasks yet. Add some!</div>
                    </div>
                </div>

                <!-- 2. Today's Schedule -->
                <div class="card" role="region" aria-labelledby="schedule-heading">
                    <h2 id="schedule-heading">Step 5: Your Adaptive Schedule for Today</h2>
                    <p class="brain-dump-subtitle" style="margin-bottom: 18px;">Drag tasks around as your energy changes</p>
                    <div class="schedule-timeline" 
                        id="schedule"
                        role="table"
                        aria-label="Today's schedule timeline">
                        <div class="empty-state" role="status" aria-live="polite">Add tasks to generate your schedule!</div>
                    </div>
                </div>

                <!-- 3. Dopamine Menu (Reward) -->
                <div class="card dopamine-card" role="region" aria-labelledby="dopamine-heading">
                    <div class="dopamine-header" 
                        onclick="toggleDopamineSection()"
                        role="button"
                        tabindex="0"
                        aria-expanded="false"
                        aria-controls="dopamineContent"
                        aria-label="Toggle dopamine menu section"
                        onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); toggleDopamineSection(); }">
                        <div>
                            <h2 id="dopamine-heading">Step 6: Dopamine Menu</h2>
                            <span id="dopamineToggleIcon" class="dopamine-toggle-icon" aria-hidden="true">▼</span>
                        </div>
                        <button class="btn-add-task dopamine-add-btn" 
                            onclick="event.stopPropagation(); toggleDopamineMenu()"
                            aria-label="Add custom dopamine activity"
                            aria-expanded="false"
                            aria-controls="dopamineInput">
                            + Custom
                        </button>
                    </div>
                    
                    <div id="dopamineContent" 
                        class="dopamine-content"
                        role="region"
                        aria-labelledby="dopamine-heading">
                        <p class="dopamine-subtitle">
                            Add fun, low-pressure tasks to your schedule today
                        </p>
                        
                        <div id="dopamineInput" 
                            style="display: none; margin-bottom: 12px;"
                            role="group"
                            aria-label="Add custom dopamine activity">
                            <input type="text" 
                                id="customDopamineItem" 
                                placeholder="What brings you joy?"
                                aria-label="Enter custom dopamine activity name"
                                style="width: calc(100% - 100px); padding: 8px; border: 2px solid var(--border); border-radius: 6px; font-size: 0.88rem; margin-right: 7px;">
                            <button class="btn-add-task dopamine-add-btn" 
                                onclick="addCustomDopamineItem()" 
                                style="padding: 8px 16px;"
                                aria-label="Add the custom dopamine activity">Add</button>
                        </div>

                        <div id="dopamineEditInput" 
                            style="display: none; margin-bottom: 12px;"
                            role="group"
                            aria-label="Edit dopamine activity">
                            <input type="text" 
                                id="editDopamineItem" 
                                placeholder="Edit activity"
                                aria-label="Edit activity name"
                                style="width: calc(50% - 55px); padding: 8px; border: 2px solid var(--border); border-radius: 6px; font-size: 0.88rem; margin-right: 7px;">
                            <input type="number" 
                                id="editDopamineDuration" 
                                placeholder="15" 
                                min="5" 
                                max="120"
                                aria-label="Duration in minutes"
                                style="width: 65px; padding: 8px; border: 2px solid var(--border); border-radius: 6px; font-size: 0.88rem; margin-right: 7px;">
                            <span style="margin-right: 7px; color: var(--text-secondary); font-size: 0.82rem;" aria-hidden="true">min</span>
                            <button class="btn-add-task dopamine-add-btn" 
                                onclick="saveDopamineEdit()" 
                                style="padding: 8px 15px; margin-right: 5px;"
                                aria-label="Save changes to dopamine activity">Save</button>
                            <button class="type-tasks-btn" 
                                onclick="cancelDopamineEdit()" 
                                style="padding: 8px 15px;"
                                aria-label="Cancel editing dopamine activity">Cancel</button>
                        </div>

                        <div class="task-list" 
                            id="dopamineList"
                            role="list"
                            aria-label="List of dopamine activities"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let tasks = [];
        let energyLevel = 'medium';
        let communicationMode = 'verbal';
        let recognition = null;
        let editingDopamineId = null;
        let dopamineSectionOpen = false;
        let draggedTaskId = null;
        
        // Energy capacity in minutes for the day - HARD CODED LIMITS
        const ENERGY_CAPACITY = { 
            1: 80,   // Low energy: max 80 minutes
            2: 120,  // Medium energy: max 120 minutes
            3: 300   // High energy: max 300 minutes
        };
        
        let dopamineItems = [
            { id: 'dop1', text: 'Watch favorite comfort show', duration: 20 },
            { id: 'dop2', text: 'Listen to favorite playlist', duration: 15 },
            { id: 'dop3', text: 'Take a short walk outside', duration: 15 },
            { id: 'dop4', text: 'Pet/cuddle with pet', duration: 10 },
            { id: 'dop5', text: 'Read a chapter of fun book', duration: 20 },
            { id: 'dop6', text: 'Scroll favorite social media', duration: 10 },
            { id: 'dop7', text: 'Play a quick game', duration: 15 },
            { id: 'dop8', text: 'Do a puzzle or coloring', duration: 20 },
            { id: 'dop9', text: 'Make a favorite snack', duration: 10 },
            { id: 'dop10', text: 'Take a relaxing shower/bath', duration: 20 }
        ];

        // AI: Estimate task duration based on keywords
        function estimateMinutes(text) {
            const lowerText = text.toLowerCase();
            
            // Very quick tasks (5 min) - check phrases first
            const veryQuickPhrases = ['drink water', 'drinking water', 'water break', 'quick break'];
            if (veryQuickPhrases.some(phrase => lowerText.includes(phrase))) return 5;
            
            // Quick tasks (10 min)
            const quickKeywords = ['email', 'reply', 'text', 'message', 'pay', 'confirm', 
                                   'snack', 'check', 'quick'];
            if (quickKeywords.some(kw => lowerText.includes(kw))) return 10;
            
            // Light tasks (15-25 min)
            const lightKeywords = ['tidy', 'clean', 'shower', 'prep', 'prepare', 'walk', 
                                   'stretch', 'organize', 'sort', 'file'];
            if (lightKeywords.some(kw => lowerText.includes(kw))) return 20;
            
            // Medium tasks (30-50 min)
            const mediumKeywords = ['meeting', 'lunch', 'dinner', 'cook', 'plan', 'write', 
                                    'report', 'record', 'review', 'read', 'study', 'pack', 'packing'];
            if (mediumKeywords.some(kw => lowerText.includes(kw))) {
                // Packing tasks are typically 40 minutes
                if (lowerText.includes('pack') || lowerText.includes('packing')) return 40;
                return 45;
            }
            
            // Deep work (90+ min)
            const deepKeywords = ['build', 'code', 'develop', 'design', 'create', 'research', 
                                  'deep work', 'project', 'presentation', 'analyze'];
            if (deepKeywords.some(kw => lowerText.includes(kw))) return 90;
            
            // No default - returns undefined if no pattern matches
            return undefined;
        }

        // AI: Estimate energy required (1=Low, 2=Medium, 3=High)
        function estimateEnergy(text) {
            const lowerText = text.toLowerCase();
            
            // Low energy (1)
            const lowKeywords = ['email', 'reply', 'text', 'message', 'pay', 'confirm', 
                                'drink', 'water', 'snack', 'check', 'scroll', 'watch', 'listen'];
            if (lowKeywords.some(kw => lowerText.includes(kw))) return 1;
            
            // High energy (3)
            const highKeywords = ['build', 'code', 'develop', 'design', 'create', 'research', 
                                 'deep work', 'project', 'presentation', 'analyze', 'write', 
                                 'meeting', 'call', 'interview'];
            if (highKeywords.some(kw => lowerText.includes(kw))) return 3;
            
            // Medium energy (2) - default
            return 2;
        }

        // Get energy label
        function getEnergyLabel(energyRequired) {
            if (energyRequired === 1) return 'Low';
            if (energyRequired === 2) return 'Medium';
            return 'High';
        }

        function loadData() {
            const saved = localStorage.getItem('ndPlannerData');
            if (saved) {
                const data = JSON.parse(saved);
                tasks = data.tasks || [];
                energyLevel = data.energyLevel || 'medium';
                communicationMode = data.communicationMode || 'verbal';
                dopamineSectionOpen = data.dopamineSectionOpen || false;
                if (data.dopamineItems) dopamineItems = data.dopamineItems;
                
                setEnergy(energyLevel);
                setCommunicationMode(communicationMode);
                
                if (dopamineSectionOpen) {
                    const content = document.getElementById('dopamineContent');
                    const icon = document.getElementById('dopamineToggleIcon');
                    const header = document.querySelector('.dopamine-header');
                    content.classList.add('active');
                    icon.textContent = '▲';
                    if (header) header.setAttribute('aria-expanded', 'true');
                }
                
                renderTasks();
                renderDopamineMenu();
                generateSchedule();
            } else {
                renderDopamineMenu();
            }
        }

        function saveData() {
            localStorage.setItem('ndPlannerData', JSON.stringify({
                tasks, energyLevel, communicationMode, dopamineItems, dopamineSectionOpen
            }));
        }

        // Drag and drop handlers for schedule
        function handleDragStart(event, taskId) {
            draggedTaskId = taskId;
            event.target.classList.add('dragging');
            event.target.setAttribute('aria-grabbed', 'true');
            event.dataTransfer.effectAllowed = 'move';
            event.dataTransfer.setData('text/html', event.target.outerHTML);
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            // Add visual feedback
            if (event.currentTarget.classList.contains('timeline-row')) {
                event.currentTarget.style.backgroundColor = '#F0F9FF';
            }
        }

        function handleDragLeave(event) {
            if (event.currentTarget.classList.contains('timeline-row')) {
                event.currentTarget.style.backgroundColor = '';
            }
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            event.target.setAttribute('aria-grabbed', 'false');
            // Remove all drag feedback
            document.querySelectorAll('.timeline-row').forEach(row => {
                row.style.backgroundColor = '';
            });
        }

        function handleDrop(event, targetHour) {
            event.preventDefault();
            event.stopPropagation();
            
            if (!draggedTaskId) return;
            
            const task = tasks.find(t => t.id === draggedTaskId);
            if (!task) return;
            
            // Calculate the new start time based on the hour
            const newStartTime = targetHour * 60; // Convert hour to minutes
            
            // Validate: check if task fits in energy capacity
            const userEnergyLevel = energyLevel === 'low' ? 1 : energyLevel === 'medium' ? 2 : 3;
            const totalCapacity = ENERGY_CAPACITY[userEnergyLevel];
            
            // Calculate total used time
            const otherTasks = tasks.filter(t => t.id !== draggedTaskId && t.scheduledTime !== undefined);
            const otherTasksTime = otherTasks.reduce((sum, t) => sum + (t.duration || 30), 0);
            const taskDuration = task.duration || 30;
            
            if (otherTasksTime + taskDuration > totalCapacity) {
                alert('Moving this task would exceed your energy capacity!');
                draggedTaskId = null;
                generateSchedule();
                return;
            }
            
            // Store the new scheduled time in the task
            task.scheduledTime = newStartTime;
            
            // Remove dragging class
            document.querySelectorAll('.timeline-event').forEach(el => {
                el.classList.remove('dragging');
                el.setAttribute('aria-grabbed', 'false');
            });
            
            // Remove drag feedback
            document.querySelectorAll('.timeline-row').forEach(row => {
                row.style.backgroundColor = '';
            });
            
            draggedTaskId = null;
            
            // Regenerate schedule with new time
            generateSchedule();
            saveData();
        }

        // Keyboard navigation for tasks
        function handleTaskKeydown(event, taskId) {
            if (event.key === ' ' || event.key === 'Enter') {
                event.preventDefault();
                toggleTaskComplete(taskId);
            } else if (event.key === 'Delete' || event.key === 'Backspace') {
                event.preventDefault();
                if (confirm('Delete this task?')) {
                    deleteTask(taskId);
                }
            }
        }

        function toggleTextInput() {
            const area = document.getElementById('textInputArea');
            const button = document.querySelector('.type-tasks-btn');
            const isActive = area.classList.contains('active');
            area.classList.toggle('active');
            
            if (area.classList.contains('active')) {
                area.setAttribute('aria-hidden', 'false');
                button.setAttribute('aria-expanded', 'true');
                document.getElementById('taskInput').focus();
            } else {
                area.setAttribute('aria-hidden', 'true');
                button.setAttribute('aria-expanded', 'false');
            }
        }

        function addTask() {
            const input = document.getElementById('taskInput');
            const text = input.value.trim();
            if (!text) return;

            const lines = text.split(/\n|•|-/).map(line => line.trim()).filter(line => line);
            
            lines.forEach((taskText, index) => {
                setTimeout(() => {
                    // AI: Estimate duration and energy for each task
                    const estimatedMinutes = estimateMinutes(taskText);
                    const energyRequired = estimateEnergy(taskText);
                    
                    tasks.push({
                        id: Date.now() + index,
                        text: taskText,
                        priority: 'flexible',
                        duration: estimatedMinutes,
                        energyRequired: energyRequired,
                        completed: false,
                        dopamine: false
                    });
                    
                    if (index === lines.length - 1) {
                        renderTasks();
                        generateSchedule();
                        saveData();
                    }
                }, index * 10);
            });

            input.value = '';
        }

        function togglePriority(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.priority = task.priority === 'important' ? 'flexible' : 'important';
                renderTasks();
                generateSchedule();
                saveData();
            }
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            renderTasks();
            generateSchedule();
            saveData();
        }

        function toggleTaskComplete(id) {
            const task = tasks.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                generateSchedule();
                saveData();
            }
        }

        function setEnergy(level) {
            energyLevel = level;
            document.querySelectorAll('.left-column .energy-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.setAttribute('aria-checked', 'false');
            });
            const buttons = document.querySelectorAll('.left-column .energy-btn');
            if (level === 'low') {
                buttons[0].classList.add('active');
                buttons[0].setAttribute('aria-checked', 'true');
            }
            if (level === 'medium') {
                buttons[1].classList.add('active');
                buttons[1].setAttribute('aria-checked', 'true');
            }
            if (level === 'high') {
                buttons[2].classList.add('active');
                buttons[2].setAttribute('aria-checked', 'true');
            }
            generateSchedule();
            saveData();
        }

        function renderTasks() {
            const container = document.getElementById('taskList');
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state" role="status" aria-live="polite">No tasks yet. Add some!</div>';
                return;
            }

            container.innerHTML = tasks.map(task => {
                // Ensure task always has duration and energy
                if (!task.duration) task.duration = 30;
                if (!task.energyRequired) task.energyRequired = 2;
                
                const energyLabel = getEnergyLabel(task.energyRequired);
                const priorityLabel = task.priority === 'important' ? 'Important' : 'Flexible';
                
                return `
                <div class="task-item ${task.priority}" role="listitem">
                    <div class="task-text">
                        <span aria-label="Task: ${task.text}, estimated ${task.duration} minutes, ${energyLabel} energy required">${task.text}</span>
                        <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 3px;" aria-hidden="true">
                            ⏱️ ${task.duration} min • ⚡ ${energyLabel} energy
                        </div>
                    </div>
                    <div class="priority-toggle ${task.priority === 'flexible' ? 'flexible-selected' : 'important-selected'}" 
                        onclick="togglePriority(${task.id})"
                        role="switch"
                        aria-label="Toggle priority. Current: ${priorityLabel}."
                        aria-checked="${task.priority === 'important' ? 'true' : 'false'}">
                        <button class="priority-toggle-option flexible" 
                            type="button"
                            onclick="event.stopPropagation(); togglePriority(${task.id})"
                            aria-label="Set priority to flexible">Flexible</button>
                        <button class="priority-toggle-option important" 
                            type="button"
                            onclick="event.stopPropagation(); togglePriority(${task.id})"
                            aria-label="Set priority to important">Important</button>
                    </div>
                    <button class="btn-delete" 
                        onclick="deleteTask(${task.id})"
                        aria-label="Delete task: ${task.text}">Delete</button>
                </div>
                `;
            }).join('');
            
            // Save to ensure duration/energy are persisted
            saveData();
        }

        function generateSchedule() {
            const container = document.getElementById('schedule');
            if (tasks.length === 0) {
                container.innerHTML = '<div class="empty-state" role="status" aria-live="polite">Add tasks to generate your schedule!</div>';
                return;
            }

            // Get user's energy level (1=low, 2=medium, 3=high)
            const userEnergyLevel = energyLevel === 'low' ? 1 : energyLevel === 'medium' ? 2 : 3;
            const totalCapacity = ENERGY_CAPACITY[userEnergyLevel];

            // Separate tasks with manual scheduling from auto-scheduled
            const manuallyScheduled = tasks.filter(t => t.scheduledTime !== undefined);
            const autoScheduled = tasks.filter(t => t.scheduledTime === undefined);

            // Sort auto-scheduled: important first
            const sortedAutoTasks = [...autoScheduled].sort((a, b) => {
                if (a.priority === 'important' && b.priority !== 'important') return -1;
                if (a.priority !== 'important' && b.priority === 'important') return 1;
                return 0;
            });

            // Build schedule array
            const schedule = [];
            
            // Add manually scheduled tasks first
            manuallyScheduled.forEach(task => {
                const taskDuration = task.duration || 30;
                const start = task.scheduledTime;
                const end = start + taskDuration;
                
                schedule.push({
                    task,
                    startTime: start,
                    endTime: end,
                    startTimeStr: formatTime(start),
                    endTimeStr: formatTime(end),
                    duration: taskDuration,
                    isManual: true
                });
            });

            // Auto-schedule remaining tasks
            let startHour = energyLevel === 'low' ? 10 : energyLevel === 'medium' ? 9 : 8;
            let currentTime = startHour * 60;
            let totalUsed = manuallyScheduled.reduce((sum, t) => sum + (t.duration || 30), 0);

            for (const task of sortedAutoTasks) {
                const taskDuration = task.duration || 30;
                
                // Check if adding this task would exceed capacity
                if (totalUsed + taskDuration <= totalCapacity) {
                    // Find next available time slot (avoid conflicts with manually scheduled)
                    const conflicts = schedule.filter(s => 
                        (currentTime >= s.startTime && currentTime < s.endTime) ||
                        (currentTime + taskDuration > s.startTime && currentTime < s.endTime)
                    );
                    
                    if (conflicts.length > 0) {
                        // Move to after the last conflict
                        const lastConflict = conflicts.reduce((max, s) => s.endTime > max ? s.endTime : max, 0);
                        currentTime = lastConflict + 15; // 15 min break
                    }
                    
                    const start = currentTime;
                    const end = currentTime + taskDuration;
                    
                    schedule.push({
                        task,
                        startTime: start,
                        endTime: end,
                        startTimeStr: formatTime(start),
                        endTimeStr: formatTime(end),
                        duration: taskDuration,
                        isManual: false
                    });
                    
                    totalUsed += taskDuration;
                    currentTime = end + 15; // 15 min break
                } else {
                    break;
                }
            }

            // Sort schedule by start time
            schedule.sort((a, b) => a.startTime - b.startTime);

            if (schedule.length === 0) {
                container.innerHTML = '<div class="empty-state" role="status" aria-live="polite">No tasks fit your energy capacity today. Try adjusting your energy level!</div>';
                return;
            }

            // Always show 9am to 9pm (full day view)
            const minHour = 9;
            const maxHour = 21; // 9pm

            let html = '';
            for (let hour = minHour; hour <= maxHour; hour++) {
                const hourStart = hour * 60;
                const hourEnd = (hour + 1) * 60;
                const eventsInHour = schedule.filter(s => 
                    (s.startTime >= hourStart && s.startTime < hourEnd) ||
                    (s.endTime > hourStart && s.endTime <= hourEnd) ||
                    (s.startTime <= hourStart && s.endTime >= hourEnd)
                );

                html += `<div class="timeline-row" 
                    role="row"
                    ondragover="handleDragOver(event)" 
                    ondrop="handleDrop(event, ${hour})"
                    ondragleave="handleDragLeave(event)"
                    aria-label="Time slot: ${formatTime(hourStart)}">
                    <div class="timeline-hour" role="columnheader">${formatTime(hourStart)}</div>
                    <div class="timeline-content" role="cell">`;
                
                eventsInHour.forEach(event => {
                    if (Math.floor(event.startTime / 60) === hour) {
                        const energyLabel = getEnergyLabel(event.task.energyRequired || 2);
                        const taskId = event.task.id;
                        const isCompleted = event.task.completed ? 'true' : 'false';
                        const taskClass = event.task.dopamine ? 'dopamine' : event.task.priority;
                        html += `
                            <div class="timeline-event ${taskClass} ${event.task.completed ? 'completed' : ''}" 
                                draggable="true" 
                                role="button"
                                tabindex="0"
                                aria-label="Task: ${event.task.text}, ${event.startTimeStr} to ${event.endTimeStr}, ${event.duration} minutes, ${energyLabel} energy. Drag to move or press space to toggle completion."
                                aria-grabbed="false"
                                ondragstart="handleDragStart(event, ${taskId})"
                                ondragend="handleDragEnd(event)"
                                onkeydown="handleTaskKeydown(event, ${taskId})">
                                <input type="checkbox" 
                                    class="timeline-checkbox" 
                                    id="task-checkbox-${taskId}"
                                    ${event.task.completed ? 'checked' : ''} 
                                    onchange="toggleTaskComplete(${taskId})"
                                    onclick="event.stopPropagation()"
                                    aria-label="Mark ${event.task.text} as ${event.task.completed ? 'incomplete' : 'complete'}">
                                <div class="timeline-event-content">
                                    <div class="timeline-event-title">${event.task.text}</div>
                                    <div class="timeline-event-time">
                                        ${event.startTimeStr} - ${event.endTimeStr} • ${event.duration} min • ⚡ ${energyLabel}
                                    </div>
                                </div>
                            </div>
                        `;
                    }
                });
                
                html += `</div></div>`;
            }
            
            // Show energy capacity used
            html += `
                <div style="margin-top: 20px; padding: 16px; background: var(--bg); border-radius: 8px; font-size: 0.85rem;" role="status" aria-live="polite">
                    <strong>Energy Used:</strong> ${totalUsed} / ${totalCapacity} min
                    <div style="margin-top: 8px; color: var(--text-secondary);">
                        ${energyLevel === 'low' ? 'Low energy max: 80min' : energyLevel === 'medium' ? 'Medium energy max: 120min' : 'High energy max: 300min'}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        function formatTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            const period = hours >= 12 ? 'PM' : 'AM';
            const displayHours = hours > 12 ? hours - 12 : hours === 0 ? 12 : hours;
            return `${displayHours}:${mins.toString().padStart(2, '0')} ${period}`;
        }

        function setCommunicationMode(mode) {
            communicationMode = mode;
            const verbalBtn = document.getElementById('verbalBtn');
            const nonverbalBtn = document.getElementById('nonverbalBtn');
            
            verbalBtn.classList.remove('active');
            nonverbalBtn.classList.remove('active');
            verbalBtn.setAttribute('aria-checked', 'false');
            nonverbalBtn.setAttribute('aria-checked', 'false');
            
            if (mode === 'verbal') {
                verbalBtn.classList.add('active');
                verbalBtn.setAttribute('aria-checked', 'true');
            } else {
                nonverbalBtn.classList.add('active');
                nonverbalBtn.setAttribute('aria-checked', 'true');
            }
            
            const voiceBtn = document.getElementById('voiceBtn');
            const orDivider = document.querySelector('.or-divider');
            const textInputArea = document.getElementById('textInputArea');
            
            if (mode === 'nonverbal') {
                voiceBtn.style.display = 'none';
                orDivider.style.display = 'none';
                textInputArea.classList.add('active');
                textInputArea.setAttribute('aria-hidden', 'false');
            } else {
                voiceBtn.style.display = 'flex';
                orDivider.style.display = 'block';
                if (!textInputArea.classList.contains('active')) {
                    textInputArea.setAttribute('aria-hidden', 'true');
                }
            }
            saveData();
        }

        function toggleDopamineSection() {
            const content = document.getElementById('dopamineContent');
            const icon = document.getElementById('dopamineToggleIcon');
            const header = document.querySelector('.dopamine-header');
            dopamineSectionOpen = !dopamineSectionOpen;
            
            if (dopamineSectionOpen) {
                content.classList.add('active');
                icon.textContent = '▲';
                header.setAttribute('aria-expanded', 'true');
            } else {
                content.classList.remove('active');
                icon.textContent = '▼';
                header.setAttribute('aria-expanded', 'false');
            }
            saveData();
        }

        function renderDopamineMenu() {
            const container = document.getElementById('dopamineList');
            container.innerHTML = dopamineItems.map(item => `
                <div class="task-item dopamine-item" 
                    role="listitem"
                    onclick="addDopamineToSchedule('${item.id}', event)"
                    tabindex="0"
                    aria-label="Dopamine activity: ${item.text}, ${item.duration} minutes. Click to add to schedule."
                    onkeydown="if(event.key==='Enter'||event.key===' ') { event.preventDefault(); addDopamineToSchedule('${item.id}', event); }">
                    <div class="task-text">${item.text}</div>
                    <span style="color: var(--text-secondary); font-size: 0.78rem; margin-right: 7px;" aria-hidden="true">${item.duration} min</span>
                    <button onclick="event.stopPropagation(); editDopamineItem('${item.id}')" 
                        style="padding: 4px 8px; background: transparent; border: none; cursor: pointer; font-size: 0.95rem;" 
                        aria-label="Edit ${item.text}"
                        title="Edit">✏️</button>
                    <button class="btn-delete" 
                        onclick="event.stopPropagation(); removeDopamineItem('${item.id}')"
                        aria-label="Delete ${item.text}">Delete</button>
                </div>
            `).join('');
        }

        function toggleDopamineMenu() {
            const input = document.getElementById('dopamineInput');
            const button = document.querySelector('.dopamine-add-btn');
            const isVisible = input.style.display !== 'none';
            input.style.display = isVisible ? 'none' : 'block';
            
            if (input.style.display === 'block') {
                button.setAttribute('aria-expanded', 'true');
                if (!dopamineSectionOpen) {
                    toggleDopamineSection();
                }
                document.getElementById('customDopamineItem').focus();
            } else {
                button.setAttribute('aria-expanded', 'false');
            }
        }

        function addCustomDopamineItem() {
            const input = document.getElementById('customDopamineItem');
            const text = input.value.trim();
            
            if (!text) return;

            dopamineItems.push({
                id: 'custom-' + Date.now(),
                text: text,
                duration: 15,
                custom: true
            });

            input.value = '';
            document.getElementById('dopamineInput').style.display = 'none';
            renderDopamineMenu();
            saveData();
        }

        function editDopamineItem(itemId) {
            const item = dopamineItems.find(d => d.id === itemId);
            if (!item) return;

            editingDopamineId = itemId;
            
            document.getElementById('dopamineEditInput').style.display = 'block';
            document.getElementById('editDopamineItem').value = item.text;
            document.getElementById('editDopamineDuration').value = item.duration;
            document.getElementById('editDopamineItem').focus();
            
            document.getElementById('dopamineInput').style.display = 'none';
        }

        function saveDopamineEdit() {
            const item = dopamineItems.find(d => d.id === editingDopamineId);
            if (!item) return;

            const newText = document.getElementById('editDopamineItem').value.trim();
            const newDuration = parseInt(document.getElementById('editDopamineDuration').value) || 15;

            if (!newText) return;

            item.text = newText;
            item.duration = newDuration;

            cancelDopamineEdit();
            renderDopamineMenu();
            saveData();
        }

        function cancelDopamineEdit() {
            editingDopamineId = null;
            document.getElementById('dopamineEditInput').style.display = 'none';
            document.getElementById('editDopamineItem').value = '';
            document.getElementById('editDopamineDuration').value = '';
        }

        function addDopamineToSchedule(itemId, event) {
            const item = dopamineItems.find(d => d.id === itemId);
            if (!item) return;

            // Dopamine items are low-energy activities
            const estimatedMinutes = item.duration || estimateMinutes(item.text);
            const energyRequired = 1; // Dopamine items are always low energy

            tasks.push({
                id: Date.now(),
                text: item.text,
                priority: 'flexible',
                duration: estimatedMinutes,
                energyRequired: energyRequired,
                dopamine: true,
                completed: false
            });

            renderTasks();
            generateSchedule();
            saveData();
            
            // Visual feedback
            if (event) {
                const targetElement = event.target.closest('.dopamine-item');
                if (targetElement) {
                    targetElement.style.background = '#D1FAE5';
                    setTimeout(() => {
                        renderDopamineMenu();
                    }, 300);
                }
            }
        }

        function removeDopamineItem(itemId) {
            dopamineItems = dopamineItems.filter(d => d.id !== itemId);
            renderDopamineMenu();
            saveData();
        }

        function toggleVoice() {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Voice input is not supported in your browser. Try Chrome!');
                return;
            }

            const btn = document.getElementById('voiceBtn');
            
            if (!recognition) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'en-US';
                recognition.maxAlternatives = 1;

                recognition.onresult = (event) => {
                    let fullTranscript = '';
                    
                    for (let i = 0; i < event.results.length; i++) {
                        fullTranscript += event.results[i][0].transcript + '. ';
                    }
                    
                    const textArea = document.getElementById('taskInput');
                    textArea.value = fullTranscript.trim();
                };

                recognition.onerror = (event) => {
                    console.log('Speech recognition error:', event.error);
                    btn.classList.remove('recording');
                    
                    if (event.error === 'no-speech') {
                        alert('No speech detected. Try speaking louder or closer to the microphone.');
                    } else if (event.error === 'not-allowed') {
                        alert('Microphone access denied. Please allow microphone access and try again.');
                    }
                };

                recognition.onend = () => {
                    btn.classList.remove('recording');
                };

                recognition.onspeechstart = () => {
                    console.log('Speech detected!');
                };

                recognition.onspeechend = () => {
                    console.log('Speech ended');
                };
            }

            if (btn.classList.contains('recording')) {
                recognition.stop();
                btn.classList.remove('recording');
                btn.setAttribute('aria-pressed', 'false');
                btn.setAttribute('aria-label', 'Start voice recording. Click to record your tasks using your microphone.');
                
                const area = document.getElementById('textInputArea');
                area.classList.add('active');
                area.setAttribute('aria-hidden', 'false');
                
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" style="fill: white; width: 40px; height: 40px;" aria-hidden="true">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>`;
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 1500);
            } else {
                recognition.start();
                btn.classList.add('recording');
                btn.setAttribute('aria-pressed', 'true');
                btn.setAttribute('aria-label', 'Stop voice recording. Click to stop recording.');
                
                const area = document.getElementById('textInputArea');
                area.classList.add('active');
                area.setAttribute('aria-hidden', 'false');
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const customInput = document.getElementById('customDopamineItem');
            if (customInput) {
                customInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCustomDopamineItem();
                    }
                });
            }
            
            const editInput = document.getElementById('editDopamineItem');
            const editDuration = document.getElementById('editDopamineDuration');
            if (editInput) {
                editInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveDopamineEdit();
                    }
                });
            }
            if (editDuration) {
                editDuration.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveDopamineEdit();
                    }
                });
            }
        });

        document.getElementById('taskInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                addTask();
            }
        });

        loadData();
    </script>
</body>
</html>
